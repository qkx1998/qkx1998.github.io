<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="赛题背景：赛题以预测二手车的交易价格为任务，数据集报名后可见并可下载，该数据来自某交易平台的二手车交易记录，总数据量超过40w，包含31列变量信息，其中15列为匿名变量。为了保证比赛的公平性，将会从中抽取15万条作为训练集，5万条作为测试集A，5万条作为测试集B，同时会对name、model、bra"/>
    

    <!--Author-->
    
        <meta name="author" content="QKX"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="天池-二手车交易价格预测"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="赛题背景：赛题以预测二手车的交易价格为任务，数据集报名后可见并可下载，该数据来自某交易平台的二手车交易记录，总数据量超过40w，包含31列变量信息，其中15列为匿名变量。为了保证比赛的公平性，将会从中抽取15万条作为训练集，5万条作为测试集A，5万条作为测试集B，同时会对name、model、bra"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="slow dive"/>

    <!--Type page-->
    
        <meta property="og:type" content="article"/>
    

    <!--Page Cover-->
    
    
        <meta property="og:image" content="http://yoursite.com/img/wallhaven-ymrj1g.jpg"/>
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    
        <meta name="twitter:image" content="http://yoursite.com/img/wallhaven-ymrj1g.jpg"/>
    

    <!-- Title -->
    
    <title>天池-二手车交易价格预测 - slow dive</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

<meta name="generator" content="Hexo 4.2.0"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">slow dive</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<header class="intro-header" style="background-image: url('/img/wallhaven-ymrj1g.jpg')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>天池-二手车交易价格预测</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2020-04-25
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <p>赛题背景：赛题以预测二手车的交易价格为任务，数据集报名后可见并可下载，该数据来自某交易平台的二手车交易记录，总数据量超过40w，包含31列变量信息，其中15列为匿名变量。为了保证比赛的公平性，将会从中抽取15万条作为训练集，5万条作为测试集A，5万条作为测试集B，同时会对name、model、brand和regionCode等信息进行脱敏。<br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/data.PNG" alt><br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E8%AF%84%E4%BB%B7%E6%8C%87%E6%A0%87.PNG" alt><br>主要工作分为以下几个方面：<br>1 数据清洗，去除异常点，无用的变量，对空缺值进行删除或填充<br>2 探索性数据分析，主要观察分布不均匀的特征，异常点以及发现特征和标签之间的相关性<br>3 特征工程 ，根据前面的分析对特征进行加工，增强特征，特征筛选<br>4 建模预测，使用LIGHTGBM对数据进行十折交叉验证</p>
<blockquote>
<blockquote>
<p>数据清洗</p>
</blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import pandas as pd</span><br><span class="line">import numpy as np </span><br><span class="line">import matplotlib.pyplot as plt</span><br><span class="line">%matplotlib inline</span><br><span class="line">import seaborn as sns</span><br><span class="line">train &#x3D; pd.read_csv(&#39;train.csv&#39;,sep&#x3D; &#39; &#39;)</span><br><span class="line">print(&#39;train shape:&#39;,train.shape)</span><br><span class="line">test &#x3D; pd.read_csv(&#39;test.csv&#39;,sep&#x3D; &#39; &#39;)</span><br><span class="line">print(&#39;test shape:&#39;,test.shape)</span><br></pre></td></tr></table></figure>
<p>对有空缺值的数据先以众数填充（因为这些变量都为分类变量）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">train[&#39;model&#39;] &#x3D; train[&#39;model&#39;].fillna(0)</span><br><span class="line">train[&#39;bodyType&#39;] &#x3D; train[&#39;bodyType&#39;].fillna(0)</span><br><span class="line">train[&#39;fuelType&#39;] &#x3D; train[&#39;fuelType&#39;].fillna(0)</span><br><span class="line">train[&#39;gearbox&#39;] &#x3D; train[&#39;gearbox&#39;].fillna(0)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">test[&#39;model&#39;] &#x3D; test[&#39;model&#39;].fillna(0)</span><br><span class="line">test[&#39;bodyType&#39;] &#x3D; test[&#39;bodyType&#39;].fillna(0)</span><br><span class="line">test[&#39;fuelType&#39;] &#x3D; test[&#39;fuelType&#39;].fillna(0)</span><br><span class="line">test[&#39;gearbox&#39;] &#x3D; test[&#39;gearbox&#39;].fillna(0)</span><br></pre></td></tr></table></figure>
<p>对各个特征进行统计计数，发现seller,offertype变量存在严重的不平衡性，故删去。<br>notRepairedDamage特征存在 - 值，我们先用nan填充。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">train.drop([&#39;seller&#39;,&#39;offerType&#39;],axis&#x3D;1,inplace&#x3D;True)</span><br><span class="line">test.drop([&#39;seller&#39;,&#39;offerType&#39;],axis&#x3D;1,inplace&#x3D;True)</span><br><span class="line">train[&#39;notRepairedDamage&#39;].replace(&#39;-&#39;,&#39;np.nan&#39;,inplace&#x3D;True)</span><br><span class="line">test[&#39;notRepairedDamage&#39;].replace(&#39;-&#39;,&#39;np.nan&#39;,inplace&#x3D;True)</span><br></pre></td></tr></table></figure>
<p>定义去除异常点的函数(利用箱线图，认为低于QL-3IQR或高于QU+3IQR的数据点是异常点)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">def outliers_proc(data, col_name, scale&#x3D;3):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    用于清洗异常值，默认用 box_plot（scale&#x3D;3）进行清洗</span><br><span class="line">    :param data: 接收 pandas 数据格式</span><br><span class="line">    :param col_name: pandas 列名</span><br><span class="line">    :param scale: 尺度</span><br><span class="line">    :return:</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def box_plot_outliers(data_ser, box_scale):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        利用箱线图去除异常值</span><br><span class="line">        :param data_ser: 接收 pandas.Series 数据格式</span><br><span class="line">        :param box_scale: 箱线图尺度，</span><br><span class="line">        :return:</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        iqr &#x3D; box_scale * (data_ser.quantile(0.75) - data_ser.quantile(0.25))   #得到IQR</span><br><span class="line">        val_low &#x3D; data_ser.quantile(0.25) - iqr                                 #得到下限 这里规定QL-(几倍的)IQR</span><br><span class="line">        val_up &#x3D; data_ser.quantile(0.75) + iqr                                  #上限  QU+（几倍的）IQR</span><br><span class="line">        rule_low &#x3D; (data_ser &lt; val_low)</span><br><span class="line">        rule_up &#x3D; (data_ser &gt; val_up)</span><br><span class="line">        return (rule_low, rule_up), (val_low, val_up)</span><br><span class="line"></span><br><span class="line">    data_n &#x3D; data.copy()</span><br><span class="line">    data_series &#x3D; data_n[col_name]</span><br><span class="line">    rule, value &#x3D; box_plot_outliers(data_series, box_scale&#x3D;scale)</span><br><span class="line">    index &#x3D; np.arange(data_series.shape[0])[rule[0] | rule[1]]</span><br><span class="line">    print(&quot;Delete number is: &#123;&#125;&quot;.format(len(index)))</span><br><span class="line">    data_n &#x3D; data_n.drop(index)</span><br><span class="line">    data_n.reset_index(drop&#x3D;True, inplace&#x3D;True)</span><br><span class="line">    print(&quot;Now column number is: &#123;&#125;&quot;.format(data_n.shape[0]))</span><br><span class="line">    index_low &#x3D; np.arange(data_series.shape[0])[rule[0]]</span><br><span class="line">    outliers &#x3D; data_series.iloc[index_low]</span><br><span class="line">    print(&quot;Description of data less than the lower bound is:&quot;)</span><br><span class="line">    print(pd.Series(outliers).describe())</span><br><span class="line">    index_up &#x3D; np.arange(data_series.shape[0])[rule[1]]</span><br><span class="line">    outliers &#x3D; data_series.iloc[index_up]</span><br><span class="line">    print(&quot;Description of data larger than the upper bound is:&quot;)</span><br><span class="line">    print(pd.Series(outliers).describe())</span><br><span class="line">    </span><br><span class="line">    fig, ax &#x3D; plt.subplots(1, 2, figsize&#x3D;(10, 7))</span><br><span class="line">    sns.boxplot(y&#x3D;data[col_name], data&#x3D;data, palette&#x3D;&quot;Set1&quot;, ax&#x3D;ax[0])</span><br><span class="line">    sns.boxplot(y&#x3D;data_n[col_name], data&#x3D;data_n, palette&#x3D;&quot;Set1&quot;, ax&#x3D;ax[1])</span><br><span class="line">    return data_n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">train &#x3D; outliers_proc(train, &#39;power&#39;, scale&#x3D;3)</span><br><span class="line">train &#x3D; outliers_proc(train, &#39;model&#39;, scale&#x3D;3)</span><br><span class="line">train &#x3D; outliers_proc(train, &#39;fuelType&#39;, scale&#x3D;3)</span><br></pre></td></tr></table></figure>
<p>去除异常点前后的箱线图对比：<br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E5%8E%BB%E9%99%A4%E5%BC%82%E5%B8%B8%E7%82%B9.PNG" alt></p>
<p>解决标签的长尾分布问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">train[&#39;price&#39;] &#x3D; np.log1p(train[&#39;price&#39;])</span><br><span class="line"></span><br><span class="line"># 合并方便后面的操作</span><br><span class="line">df &#x3D; pd.concat([train, test], ignore_index&#x3D;True)</span><br><span class="line"></span><br><span class="line">#题目规定了范围的power(0~600)。处理一下</span><br><span class="line"></span><br><span class="line">df[&#39;power&#39;] &#x3D; df[&#39;power&#39;].map(lambda x: 600 if x&gt;600 else x)</span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>探索性数据分析</p>
</blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#统计缺失值</span><br><span class="line">trainmissing &#x3D; train.isnull().sum()</span><br><span class="line">trainmissing[trainmissing &gt; 0].sort_values().plot.bar()</span><br><span class="line">testmissing &#x3D; test.isnull().sum()</span><br><span class="line">testmissing[testmissing &gt; 0].sort_values().plot.bar()</span><br><span class="line"></span><br><span class="line">#观察定性变量的分布</span><br><span class="line">cols &#x3D; [&#39;model&#39;,&#39;brand&#39;,&#39;bodyType&#39;,&#39;fuelType&#39;,&#39;gearbox&#39;,&#39;notRepairedDamage&#39;,&#39;regionCode&#39;,&#39;seller&#39;,&#39;offerType&#39;]</span><br><span class="line">for col in cols:</span><br><span class="line">    s &#x3D; train[col].value_counts()</span><br><span class="line">    print(col)</span><br><span class="line">    print(s)</span><br><span class="line">    print(&#39;-----------------------------------&#39;)</span><br><span class="line"></span><br><span class="line">#做出一些特征的箱线图</span><br><span class="line">cols &#x3D; [&#39;model&#39;,&#39;brand&#39;,&#39;bodyType&#39;,&#39;fuelType&#39;,&#39;gearbox&#39;,&#39;notRepairedDamage&#39;]</span><br><span class="line">for c in cols:</span><br><span class="line">    train[c] &#x3D; train[c].astype(&#39;category&#39;)</span><br><span class="line">def boxplot(x,y,**kwargs):</span><br><span class="line">    sns.boxplot(x&#x3D;x,y&#x3D;y)</span><br><span class="line">    x &#x3D; plt.xticks(rotation&#x3D;90)</span><br><span class="line">    </span><br><span class="line">f &#x3D; pd.melt(train,id_vars&#x3D;[&#39;price&#39;],value_vars &#x3D; cols)</span><br><span class="line">g &#x3D; sns.FacetGrid(f,col&#x3D;&#39;variable&#39;,col_wrap&#x3D;2,sharex&#x3D;False,sharey&#x3D;False,size&#x3D;5)</span><br><span class="line">g &#x3D; g.map(boxplot,&#39;value&#39;,&#39;price&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#观察定量变量的分布</span><br><span class="line">number &#x3D; [&#39;power&#39;,&#39;kilometer&#39;,&#39;v_0&#39;,&#39;v_1&#39;,&#39;v_2&#39;,&#39;v_3&#39;,&#39;v_4&#39;,&#39;v_5&#39;,&#39;v_6&#39;,&#39;v_7&#39;,&#39;v_8&#39;,&#39;v_9&#39;,&#39;v_10&#39;,&#39;v_11&#39;,&#39;v_12&#39;,&#39;v_13&#39;,&#39;v_14&#39;,&#39;price&#39;]</span><br><span class="line"></span><br><span class="line">for col in number:</span><br><span class="line">    n &#x3D; train[col].value_counts()</span><br><span class="line">    print(col)</span><br><span class="line">    print(n)</span><br><span class="line">    print(&#39;-----------------------------------&#39;)</span><br><span class="line"></span><br><span class="line">#对可读性差的定量变量进行相关性分析</span><br><span class="line">corr &#x3D; train[number].corr()</span><br><span class="line">corr[&#39;price&#39;].sort_values()</span><br><span class="line">plt.figure(figsize&#x3D;(10,8))</span><br><span class="line">sns.heatmap(corr,square&#x3D;True,vmax&#x3D;0.8)</span><br><span class="line"></span><br><span class="line">#预测值的分布</span><br><span class="line">train[&#39;price&#39;].hist()</span><br></pre></td></tr></table></figure>
<p>EDA一步应该和数据清洗，特征工程相辅相成，前面的代码有不少思路来源于EDA。<br>主要从以下几个方面来分析数据：<br>    1 缺失<br>    2 变量分布<br>    3 相关关系<br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E8%AE%AD%E7%BB%83%E9%9B%86%E7%BC%BA%E5%A4%B1%E5%80%BC%E5%88%86%E5%B8%83.PNG" alt><br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BC%BA%E5%A4%B1%E5%80%BC%E5%88%86%E5%B8%83.PNG" alt><br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E5%AE%9A%E6%80%A7%E6%95%B0%E6%8D%AE%E7%AE%B1%E7%BA%BF%E5%9B%BE.PNG" alt><br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E5%AE%9A%E9%87%8F%E6%95%B0%E6%8D%AE%E7%83%AD%E5%8A%9B%E5%9B%BE.PNG" alt><br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E9%A2%84%E6%B5%8B%E5%80%BC%E5%88%86%E5%B8%83.PNG" alt></p>
<blockquote>
<blockquote>
<p>特征工程<br>提取时间，地区</p>
</blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">from datetime import datetime</span><br><span class="line">def date_process(x):</span><br><span class="line"></span><br><span class="line">    year &#x3D; int(str(x)[:4])</span><br><span class="line">    month &#x3D; int(str(x)[4:6])</span><br><span class="line">    day &#x3D; int(str(x)[6:8])</span><br><span class="line"></span><br><span class="line">    if month &lt; 1:</span><br><span class="line">        month &#x3D; 1</span><br><span class="line"></span><br><span class="line">    date &#x3D; datetime(year, month, day)</span><br><span class="line">    return date</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">df[&#39;regDate&#39;] &#x3D; df[&#39;regDate&#39;].apply(date_process)</span><br><span class="line">df[&#39;creatDate&#39;] &#x3D; df[&#39;creatDate&#39;].apply(date_process)</span><br><span class="line">df[&#39;regDate_year&#39;] &#x3D; df[&#39;regDate&#39;].dt.year</span><br><span class="line">df[&#39;regDate_month&#39;] &#x3D; df[&#39;regDate&#39;].dt.month</span><br><span class="line">df[&#39;regDate_day&#39;] &#x3D; df[&#39;regDate&#39;].dt.day</span><br><span class="line">df[&#39;creatDate_year&#39;] &#x3D; df[&#39;creatDate&#39;].dt.year</span><br><span class="line">df[&#39;creatDate_month&#39;] &#x3D; df[&#39;creatDate&#39;].dt.month</span><br><span class="line">df[&#39;creatDate_day&#39;] &#x3D; df[&#39;creatDate&#39;].dt.day</span><br><span class="line">df[&#39;car_age_day&#39;] &#x3D; (df[&#39;creatDate&#39;] - df[&#39;regDate&#39;]).dt.days</span><br><span class="line">df[&#39;car_age_year&#39;] &#x3D; round(df[&#39;car_age_day&#39;] &#x2F; 365, 1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#地区</span><br><span class="line"></span><br><span class="line">df[&#39;regionCode_count&#39;] &#x3D; df.groupby([&#39;regionCode&#39;])[&#39;SaleID&#39;].transform(&#39;count&#39;)</span><br><span class="line">df[&#39;city&#39;] &#x3D; df[&#39;regionCode&#39;].apply(lambda x : str(x)[:2])</span><br></pre></td></tr></table></figure>
<p>对可分类的连续特征进行分桶，kilometer是已经分桶了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bin &#x3D; [i*10 for i in range(31)]</span><br><span class="line">df[&#39;power_bin&#39;] &#x3D; pd.cut(df[&#39;power&#39;], bin, labels&#x3D;False)</span><br><span class="line">tong &#x3D; df[[&#39;power_bin&#39;, &#39;power&#39;]].head()</span><br><span class="line"></span><br><span class="line">bin &#x3D; [i*10 for i in range(24)]</span><br><span class="line">df[&#39;model_bin&#39;] &#x3D; pd.cut(df[&#39;model&#39;], bin, labels&#x3D;False)</span><br><span class="line">tong &#x3D; df[[&#39;model_bin&#39;, &#39;model&#39;]].head()</span><br></pre></td></tr></table></figure>
<p>将稍微取值多一点的分类特征与price进行特征组合,聚类分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Train_gb &#x3D; Train_data.groupby(&quot;regionCode&quot;)</span><br><span class="line">all_info &#x3D; &#123;&#125;</span><br><span class="line">for kind, kind_data in Train_gb:</span><br><span class="line">    info &#x3D; &#123;&#125;</span><br><span class="line">    kind_data &#x3D; kind_data[kind_data[&#39;price&#39;] &gt; 0]</span><br><span class="line">    info[&#39;regionCode_amount&#39;] &#x3D; len(kind_data)</span><br><span class="line">    info[&#39;regionCode_price_max&#39;] &#x3D; kind_data.price.max()</span><br><span class="line">    info[&#39;regionCode_price_median&#39;] &#x3D; kind_data.price.median()</span><br><span class="line">    info[&#39;regionCode_price_min&#39;] &#x3D; kind_data.price.min()</span><br><span class="line">    info[&#39;regionCode_price_sum&#39;] &#x3D; kind_data.price.sum()</span><br><span class="line">    info[&#39;regionCode_price_std&#39;] &#x3D; kind_data.price.std()</span><br><span class="line">    info[&#39;regionCode_price_mean&#39;] &#x3D; kind_data.price.mean()</span><br><span class="line">    info[&#39;regionCode_price_skew&#39;] &#x3D; kind_data.price.skew()</span><br><span class="line">    info[&#39;regionCode_price_kurt&#39;] &#x3D; kind_data.price.kurt()</span><br><span class="line">    info[&#39;regionCode_mad&#39;] &#x3D; kind_data.price.mad()</span><br><span class="line"></span><br><span class="line">    all_info[kind] &#x3D; info</span><br><span class="line">brand_fe &#x3D; pd.DataFrame(all_info).T.reset_index().rename(columns&#x3D;&#123;&quot;index&quot;: &quot;regionCode&quot;&#125;)</span><br><span class="line">df &#x3D; df.merge(brand_fe, how&#x3D;&#39;left&#39;, on&#x3D;&#39;regionCode&#39;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Train_gb &#x3D; Train_data.groupby(&quot;brand&quot;)</span><br><span class="line">all_info &#x3D; &#123;&#125;</span><br><span class="line">for kind, kind_data in Train_gb:</span><br><span class="line">    info &#x3D; &#123;&#125;</span><br><span class="line">    kind_data &#x3D; kind_data[kind_data[&#39;price&#39;] &gt; 0]</span><br><span class="line">    info[&#39;brand_amount&#39;] &#x3D; len(kind_data)</span><br><span class="line">    info[&#39;brand_price_max&#39;] &#x3D; kind_data.price.max()</span><br><span class="line">    info[&#39;brand_price_median&#39;] &#x3D; kind_data.price.median()</span><br><span class="line">    info[&#39;brand_price_min&#39;] &#x3D; kind_data.price.min()</span><br><span class="line">    info[&#39;brand_price_sum&#39;] &#x3D; kind_data.price.sum()</span><br><span class="line">    info[&#39;brand_price_std&#39;] &#x3D; kind_data.price.std()</span><br><span class="line">    info[&#39;brand_price_mean&#39;] &#x3D; kind_data.price.mean()</span><br><span class="line">    info[&#39;brand_price_skew&#39;] &#x3D; kind_data.price.skew()</span><br><span class="line">    info[&#39;brand_price_kurt&#39;] &#x3D; kind_data.price.kurt()</span><br><span class="line">    info[&#39;brand_price_mad&#39;] &#x3D; kind_data.price.mad()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    all_info[kind] &#x3D; info</span><br><span class="line">brand_fe &#x3D; pd.DataFrame(all_info).T.reset_index().rename(columns&#x3D;&#123;&quot;index&quot;: &quot;brand&quot;&#125;)</span><br><span class="line">df &#x3D; df.merge(brand_fe, how&#x3D;&#39;left&#39;, on&#x3D;&#39;brand&#39;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Train_gb &#x3D; Train_data.groupby(&quot;model&quot;)</span><br><span class="line">all_info &#x3D; &#123;&#125;</span><br><span class="line">for kind, kind_data in Train_gb:</span><br><span class="line">    info &#x3D; &#123;&#125;</span><br><span class="line">    kind_data &#x3D; kind_data[kind_data[&#39;price&#39;] &gt; 0]</span><br><span class="line">    info[&#39;model_amount&#39;] &#x3D; len(kind_data)</span><br><span class="line">    info[&#39;model_price_max&#39;] &#x3D; kind_data.price.max()</span><br><span class="line">    info[&#39;model_price_median&#39;] &#x3D; kind_data.price.median()</span><br><span class="line">    info[&#39;model_price_min&#39;] &#x3D; kind_data.price.min()</span><br><span class="line">    info[&#39;model_price_sum&#39;] &#x3D; kind_data.price.sum()</span><br><span class="line">    info[&#39;model_price_std&#39;] &#x3D; kind_data.price.std()</span><br><span class="line">    info[&#39;model_price_mean&#39;] &#x3D; kind_data.price.mean()</span><br><span class="line">    info[&#39;model_price_skew&#39;] &#x3D; kind_data.price.skew()</span><br><span class="line">    info[&#39;model_price_kurt&#39;] &#x3D; kind_data.price.kurt()</span><br><span class="line">    info[&#39;model_price_mad&#39;] &#x3D; kind_data.price.mad()</span><br><span class="line"></span><br><span class="line">    all_info[kind] &#x3D; info</span><br><span class="line">brand_fe &#x3D; pd.DataFrame(all_info).T.reset_index().rename(columns&#x3D;&#123;&quot;index&quot;: &quot;model&quot;&#125;)</span><br><span class="line">df &#x3D; df.merge(brand_fe, how&#x3D;&#39;left&#39;, on&#x3D;&#39;model&#39;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Train_gb &#x3D; Train_data.groupby(&quot;kilometer&quot;)</span><br><span class="line">all_info &#x3D; &#123;&#125;</span><br><span class="line">for kind, kind_data in Train_gb:</span><br><span class="line">    info &#x3D; &#123;&#125;</span><br><span class="line">    kind_data &#x3D; kind_data[kind_data[&#39;price&#39;] &gt; 0]</span><br><span class="line">    info[&#39;kilometer_amount&#39;] &#x3D; len(kind_data)</span><br><span class="line">    info[&#39;kilometer_price_max&#39;] &#x3D; kind_data.price.max()</span><br><span class="line">    info[&#39;kilometer_price_median&#39;] &#x3D; kind_data.price.median()</span><br><span class="line">    info[&#39;kilometer_price_min&#39;] &#x3D; kind_data.price.min()</span><br><span class="line">    info[&#39;kilometer_price_sum&#39;] &#x3D; kind_data.price.sum()</span><br><span class="line">    info[&#39;kilometer_price_std&#39;] &#x3D; kind_data.price.std()</span><br><span class="line">    info[&#39;kilometer_price_mean&#39;] &#x3D; kind_data.price.mean()</span><br><span class="line">    info[&#39;kilometer_price_skew&#39;] &#x3D; kind_data.price.skew()</span><br><span class="line">    info[&#39;kilometer_price_kurt&#39;] &#x3D; kind_data.price.kurt()</span><br><span class="line">    info[&#39;kilometer_price_mad&#39;] &#x3D; kind_data.price.mad()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    all_info[kind] &#x3D; info</span><br><span class="line">brand_fe &#x3D; pd.DataFrame(all_info).T.reset_index().rename(columns&#x3D;&#123;&quot;index&quot;: &quot;kilometer&quot;&#125;)</span><br><span class="line">df &#x3D; df.merge(brand_fe, how&#x3D;&#39;left&#39;, on&#x3D;&#39;kilometer&#39;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Train_gb &#x3D; Train_data.groupby(&quot;bodyType&quot;)</span><br><span class="line">all_info &#x3D; &#123;&#125;</span><br><span class="line">for kind, kind_data in Train_gb:</span><br><span class="line">    info &#x3D; &#123;&#125;</span><br><span class="line">    kind_data &#x3D; kind_data[kind_data[&#39;price&#39;] &gt; 0]</span><br><span class="line">    info[&#39;bodyType_amount&#39;] &#x3D; len(kind_data)</span><br><span class="line">    info[&#39;bodyType_price_max&#39;] &#x3D; kind_data.price.max()</span><br><span class="line">    info[&#39;bodyType_price_median&#39;] &#x3D; kind_data.price.median()</span><br><span class="line">    info[&#39;bodyType_price_min&#39;] &#x3D; kind_data.price.min()</span><br><span class="line">    info[&#39;bodyType_price_sum&#39;] &#x3D; kind_data.price.sum()</span><br><span class="line">    info[&#39;bodyType_price_std&#39;] &#x3D; kind_data.price.std()</span><br><span class="line">    info[&#39;bodyType_price_mean&#39;] &#x3D; kind_data.price.mean()</span><br><span class="line">    info[&#39;bodyType_price_skew&#39;] &#x3D; kind_data.price.skew()</span><br><span class="line">    info[&#39;bodyType_price_kurt&#39;] &#x3D; kind_data.price.kurt()</span><br><span class="line">    info[&#39;bodyType_price_mad&#39;] &#x3D; kind_data.price.mad()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    all_info[kind] &#x3D; info</span><br><span class="line">brand_fe &#x3D; pd.DataFrame(all_info).T.reset_index().rename(columns&#x3D;&#123;&quot;index&quot;: &quot;bodyType&quot;&#125;)</span><br><span class="line">df &#x3D; df.merge(brand_fe, how&#x3D;&#39;left&#39;, on&#x3D;&#39;bodyType&#39;)</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Train_gb &#x3D; Train_data.groupby(&quot;fuelType&quot;)</span><br><span class="line">all_info &#x3D; &#123;&#125;</span><br><span class="line">for kind, kind_data in Train_gb:</span><br><span class="line">    info &#x3D; &#123;&#125;</span><br><span class="line">    kind_data &#x3D; kind_data[kind_data[&#39;price&#39;] &gt; 0]</span><br><span class="line">    info[&#39;fuelType_amount&#39;] &#x3D; len(kind_data)</span><br><span class="line">    info[&#39;fuelType_price_max&#39;] &#x3D; kind_data.price.max()</span><br><span class="line">    info[&#39;fuelType_price_median&#39;] &#x3D; kind_data.price.median()</span><br><span class="line">    info[&#39;fuelType_price_min&#39;] &#x3D; kind_data.price.min()</span><br><span class="line">    info[&#39;fuelType_price_sum&#39;] &#x3D; kind_data.price.sum()</span><br><span class="line">    info[&#39;fuelType_price_std&#39;] &#x3D; kind_data.price.std()</span><br><span class="line">    info[&#39;fuelType_price_mean&#39;] &#x3D; kind_data.price.mean()</span><br><span class="line">    info[&#39;fuelType_price_skew&#39;] &#x3D; kind_data.price.skew()</span><br><span class="line">    info[&#39;fuelType_price_kurt&#39;] &#x3D; kind_data.price.kurt()</span><br><span class="line">    info[&#39;fuelType_price_mad&#39;] &#x3D; kind_data.price.mad()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    all_info[kind] &#x3D; info</span><br><span class="line">brand_fe &#x3D; pd.DataFrame(all_info).T.reset_index().rename(columns&#x3D;&#123;&quot;index&quot;: &quot;fuelType&quot;&#125;)</span><br><span class="line">df &#x3D; df.merge(brand_fe, how&#x3D;&#39;left&#39;, on&#x3D;&#39;fuelType&#39;)</span><br></pre></td></tr></table></figure>
<p>从使用年限，使用里程角度新建特征（使用年限越长，里程越多，二手车的折扣越大）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 使用年限折旧</span><br><span class="line">def depreciation_year1(year):</span><br><span class="line">    if year &lt;&#x3D; 3:</span><br><span class="line">        return 1 - year * 0.15</span><br><span class="line">    elif year &gt; 3 and  year &lt;&#x3D; 7:</span><br><span class="line">        return 0.55 - (year-3) * 0.1</span><br><span class="line">    elif year &gt; 7 and  year &lt;&#x3D; 10:</span><br><span class="line">        return 0.25 - (year-7) * 0.05</span><br><span class="line">    else:</span><br><span class="line">        return 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def depreciation_year2(year):</span><br><span class="line">    if year &lt;&#x3D; 3:</span><br><span class="line">        return 1 - 0.85 * year * 0.11</span><br><span class="line">    elif year &gt; 3 and  year &lt;&#x3D; 7:</span><br><span class="line">        return 0.7195 - 0.85 * (year-3) * 0.1</span><br><span class="line">    elif year &gt; 7 and  year &lt;&#x3D; 10:</span><br><span class="line">        return 0.3795 - 0.85 * (year-7) * 0.09</span><br><span class="line">    else:</span><br><span class="line">        return 0.15</span><br><span class="line">    </span><br><span class="line">#行驶里程</span><br><span class="line">def depreciation_kilometer(kilo):</span><br><span class="line">    if kilo &lt;&#x3D; 6:</span><br><span class="line">        return 1 - kilo * 5 &#x2F; 90</span><br><span class="line">    elif kilo &gt; 6 and  kilo &lt;&#x3D; 12:</span><br><span class="line">        return 0.66667 - (kilo-6) * 4 &#x2F; 90</span><br><span class="line">    elif kilo &gt; 12 and  kilo &lt;&#x3D; 18:</span><br><span class="line">        return 0.4 - (kilo-12) * 3 &#x2F; 90</span><br><span class="line">    elif kilo &gt; 18 and  kilo &lt;&#x3D; 24:</span><br><span class="line">        return 0.2 - (kilo-18) * 2 &#x2F; 90</span><br><span class="line">    elif kilo &gt; 24 and  kilo &lt;&#x3D; 30:</span><br><span class="line">        return 0.06667 - (kilo-24) * 1 &#x2F; 90</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#提取车的使用时间</span><br><span class="line">df[&#39;used_time_day&#39;] &#x3D; (pd.to_datetime(df[&#39;creatDate&#39;], format&#x3D;&#39;%Y%m%d&#39;, errors&#x3D;&#39;coerce&#39;) - </span><br><span class="line">                            pd.to_datetime(df[&#39;regDate&#39;], format&#x3D;&#39;%Y%m%d&#39;, errors&#x3D;&#39;coerce&#39;)).dt.days</span><br><span class="line">df[&#39;used_time_month&#39;] &#x3D; round(df[&#39;used_time_day&#39;] &#x2F; 30)</span><br><span class="line">df[&#39;used_time_year&#39;] &#x3D; round(df[&#39;used_time_day&#39;] &#x2F; 365)</span><br><span class="line"></span><br><span class="line">#提取使用年限折扣  使用里程折扣</span><br><span class="line">df[&#39;depreciation_year1&#39;] &#x3D; df[&#39;used_time_year&#39;].apply(lambda x: depreciation_year1(x))</span><br><span class="line">df[&#39;depreciation_year2&#39;] &#x3D; df[&#39;used_time_year&#39;].apply(lambda x: depreciation_year2(x))</span><br><span class="line">df[&#39;depreciation_kilo&#39;] &#x3D; df[&#39;kilometer&#39;].apply(lambda x: depreciation_kilometer(x))</span><br></pre></td></tr></table></figure>

<p>补充的特征工程<br>主要是对匿名特征和几个重要度较高的分类特征进行特征交叉</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#第一批特征工程</span><br><span class="line"></span><br><span class="line">for i in range(15):</span><br><span class="line">    for j in range(15):</span><br><span class="line">        df[&#39;new&#39;+str(i)+&#39;*&#39;+str(j)]&#x3D;df[&#39;v_&#39;+str(i)]*df[&#39;v_&#39;+str(j)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第二批特征工程</span><br><span class="line">for i in range(15):</span><br><span class="line">    for j in range(15):</span><br><span class="line">        df[&#39;new&#39;+str(i)+&#39;+&#39;+str(j)]&#x3D;df[&#39;v_&#39;+str(i)]+df[&#39;v_&#39;+str(j)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 第三批特征工程</span><br><span class="line">for i in range(15):</span><br><span class="line">    df[&#39;new&#39; + str(i) + &#39;*power&#39;] &#x3D; df[&#39;v_&#39; + str(i)] * df[&#39;power&#39;]</span><br><span class="line"></span><br><span class="line">for i in range(15):</span><br><span class="line">    df[&#39;new&#39; + str(i) + &#39;*day&#39;] &#x3D; df[&#39;v_&#39; + str(i)] * df[&#39;car_age_day&#39;]</span><br><span class="line"></span><br><span class="line">for i in range(15):</span><br><span class="line">    df[&#39;new&#39; + str(i) + &#39;*year&#39;] &#x3D; df[&#39;v_&#39; + str(i)] * df[&#39;car_age_year&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#第四批特征工程</span><br><span class="line">for i in range(15):</span><br><span class="line">    for j in range(15):</span><br><span class="line">        df[&#39;new&#39;+str(i)+&#39;-&#39;+str(j)]&#x3D;df[&#39;v_&#39;+str(i)]-df[&#39;v_&#39;+str(j)]</span><br></pre></td></tr></table></figure>

<p>五、筛选特征</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">numerical_cols &#x3D; df.select_dtypes(exclude&#x3D;&#39;object&#39;).columns</span><br><span class="line">list_tree &#x3D; [ &#39;model_power_sum&#39;,&#39;price&#39;,&#39;SaleID&#39;,</span><br><span class="line"> &#39;model_power_std&#39;, &#39;model_power_median&#39;, &#39;model_power_max&#39;,</span><br><span class="line"> &#39;brand_price_max&#39;, &#39;brand_price_median&#39;,</span><br><span class="line"> &#39;brand_price_sum&#39;, &#39;brand_price_std&#39;,</span><br><span class="line"> &#39;model_days_sum&#39;,</span><br><span class="line"> &#39;model_days_std&#39;, &#39;model_days_median&#39;, &#39;model_days_max&#39;, &#39;model_bin&#39;, &#39;model_amount&#39;,</span><br><span class="line"> &#39;model_price_max&#39;, &#39;model_price_median&#39;,</span><br><span class="line"> &#39;model_price_min&#39;, &#39;model_price_sum&#39;, &#39;model_price_std&#39;,</span><br><span class="line"> &#39;model_price_mean&#39;, &#39;bodyType&#39;, &#39;model&#39;, &#39;brand&#39;, &#39;fuelType&#39;, &#39;gearbox&#39;, &#39;power&#39;, &#39;kilometer&#39;,</span><br><span class="line"> &#39;notRepairedDamage&#39;, &#39;v_0&#39;, &#39;v_1&#39;, &#39;v_2&#39;, &#39;v_3&#39;, &#39;v_4&#39;, &#39;v_5&#39;, &#39;v_6&#39;, &#39;v_7&#39;, &#39;v_8&#39;, &#39;v_9&#39;, &#39;v_10&#39;,</span><br><span class="line"> &#39;v_11&#39;, &#39;v_12&#39;, &#39;v_13&#39;, &#39;v_14&#39;, &#39;name_count&#39;, &#39;regDate_year&#39;, &#39;car_age_day&#39;, &#39;car_age_year&#39;,</span><br><span class="line"> &#39;power_bin&#39;,&#39;fuelType&#39;, &#39;gearbox&#39;, &#39;kilometer&#39;, &#39;notRepairedDamage&#39;,  &#39;name_count&#39;, &#39;car_age_day&#39;, &#39;new3*3&#39;, &#39;new12*14&#39;, &#39;new2*14&#39;,&#39;new14*14&#39;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(15):</span><br><span class="line">    for j in range(15):</span><br><span class="line">        list_tree.append(&#39;new&#39;+str(i)+&#39;+&#39;+str(j))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">feature_cols &#x3D; [col for col in numerical_cols if</span><br><span class="line">             col  in</span><br><span class="line">             list_tree]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">feature_cols &#x3D; [col for col in feature_cols if</span><br><span class="line">             col  not in</span><br><span class="line">             [&#39;new14+6&#39;, &#39;new13+6&#39;, &#39;new0+12&#39;, &#39;new9+11&#39;, &#39;v_3&#39;, &#39;new11+10&#39;, &#39;new10+14&#39;, &#39;new12+4&#39;, &#39;new3+4&#39;, &#39;new11+11&#39;, &#39;new13+3&#39;, &#39;new8+1&#39;, &#39;new1+7&#39;, &#39;new11+14&#39;, &#39;new8+13&#39;, &#39;v_8&#39;, &#39;v_0&#39;, &#39;new3+5&#39;, &#39;new2+9&#39;, &#39;new9+2&#39;, &#39;new0+11&#39;, &#39;new13+7&#39;, &#39;new8+11&#39;, &#39;new5+12&#39;, &#39;new10+10&#39;, &#39;new13+8&#39;, &#39;new11+13&#39;, &#39;new7+9&#39;, &#39;v_1&#39;, &#39;new7+4&#39;, &#39;new13+4&#39;, &#39;v_7&#39;, &#39;new5+6&#39;, &#39;new7+3&#39;, &#39;new9+10&#39;, &#39;new11+12&#39;, &#39;new0+5&#39;, &#39;new4+13&#39;, &#39;new8+0&#39;, &#39;new0+7&#39;, &#39;new12+8&#39;, &#39;new10+8&#39;, &#39;new13+14&#39;, &#39;new5+7&#39;, &#39;new2+7&#39;, &#39;v_4&#39;, &#39;v_10&#39;, &#39;new4+8&#39;, &#39;new8+14&#39;, &#39;new5+9&#39;, &#39;new9+13&#39;, &#39;new2+12&#39;, &#39;new5+8&#39;, &#39;new3+12&#39;, &#39;new0+10&#39;, &#39;new9+0&#39;, &#39;new1+11&#39;, &#39;new8+4&#39;, &#39;new11+8&#39;, &#39;new1+1&#39;, &#39;new10+5&#39;, &#39;new8+2&#39;, &#39;new6+1&#39;, &#39;new2+1&#39;, &#39;new1+12&#39;, &#39;new2+5&#39;, &#39;new0+14&#39;, &#39;new4+7&#39;, &#39;new14+9&#39;, &#39;new0+2&#39;, &#39;new4+1&#39;, &#39;new7+11&#39;, &#39;new13+10&#39;, &#39;new6+3&#39;, &#39;new1+10&#39;, &#39;v_9&#39;, &#39;new3+6&#39;, &#39;new12+1&#39;, &#39;new9+3&#39;, &#39;new4+5&#39;, &#39;new12+9&#39;, &#39;new3+8&#39;, &#39;new0+8&#39;, &#39;new1+8&#39;, &#39;new1+6&#39;, &#39;new10+9&#39;, &#39;new5+4&#39;, &#39;new13+1&#39;, &#39;new3+7&#39;, &#39;new6+4&#39;, &#39;new6+7&#39;, &#39;new13+0&#39;, &#39;new1+14&#39;, &#39;new3+11&#39;, &#39;new6+8&#39;, &#39;new0+9&#39;, &#39;new2+14&#39;, &#39;new6+2&#39;, &#39;new12+12&#39;, &#39;new7+12&#39;, &#39;new12+6&#39;, &#39;new12+14&#39;, &#39;new4+10&#39;, &#39;new2+4&#39;, &#39;new6+0&#39;, &#39;new3+9&#39;, &#39;new2+8&#39;, &#39;new6+11&#39;, &#39;new3+10&#39;, &#39;new7+0&#39;, &#39;v_11&#39;, &#39;new1+3&#39;, &#39;new8+3&#39;, &#39;new12+13&#39;, &#39;new1+9&#39;, &#39;new10+13&#39;, &#39;new5+10&#39;, &#39;new2+2&#39;, &#39;new6+9&#39;, &#39;new7+10&#39;, &#39;new0+0&#39;, &#39;new11+7&#39;, &#39;new2+13&#39;, &#39;new11+1&#39;, &#39;new5+11&#39;, &#39;new4+6&#39;, &#39;new12+2&#39;, &#39;new4+4&#39;, &#39;new6+14&#39;, &#39;new0+1&#39;, &#39;new4+14&#39;, &#39;v_5&#39;, &#39;new4+11&#39;, &#39;v_6&#39;, &#39;new0+4&#39;, &#39;new1+5&#39;, &#39;new3+14&#39;, &#39;new2+10&#39;, &#39;new9+4&#39;, &#39;new2+6&#39;, &#39;new14+14&#39;, &#39;new11+6&#39;, &#39;new9+1&#39;, &#39;new3+13&#39;, &#39;new13+13&#39;, &#39;new10+6&#39;, &#39;new2+3&#39;, &#39;new2+11&#39;, &#39;new1+4&#39;, &#39;v_2&#39;, &#39;new5+13&#39;, &#39;new4+2&#39;, &#39;new0+6&#39;, &#39;new7+13&#39;, &#39;new8+9&#39;, &#39;new9+12&#39;, &#39;new0+13&#39;, &#39;new10+12&#39;, &#39;new5+14&#39;, &#39;new6+10&#39;, &#39;new10+7&#39;, &#39;v_13&#39;, &#39;new5+2&#39;, &#39;new6+13&#39;, &#39;new9+14&#39;, &#39;new13+9&#39;, &#39;new14+7&#39;, &#39;new8+12&#39;, &#39;new3+3&#39;, &#39;new6+12&#39;, &#39;v_12&#39;, &#39;new14+4&#39;, &#39;new11+9&#39;, &#39;new12+7&#39;, &#39;new4+9&#39;, &#39;new4+12&#39;, &#39;new1+13&#39;, &#39;new0+3&#39;, &#39;new8+10&#39;, &#39;new13+11&#39;, &#39;new7+8&#39;, &#39;new7+14&#39;, &#39;v_14&#39;, &#39;new10+11&#39;, &#39;new14+8&#39;, &#39;new1+2&#39;]]</span><br><span class="line"></span><br><span class="line">df &#x3D; df[feature_cols]</span><br></pre></td></tr></table></figure>
<p>导出数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tree_data &#x3D; df</span><br><span class="line">print(tree_data.shape)</span><br><span class="line">train_num &#x3D; df.shape[0]-50000</span><br><span class="line">tree_data[0:int(train_num)].to_csv(&#39;train_tree.csv&#39;, index&#x3D;0,sep&#x3D;&#39; &#39;)</span><br><span class="line">tree_data[train_num:train_num+50000].to_csv(&#39;text_tree.csv&#39;, index&#x3D;0,sep&#x3D;&#39; &#39;)</span><br><span class="line"></span><br><span class="line">print(&#39;树模型数据已经准备完毕~~~~~~~&#39;)</span><br></pre></td></tr></table></figure>
<blockquote>
<blockquote>
<p>建模预测</p>
</blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Train_data &#x3D; pd.read_csv(&#39;train_tree.csv&#39;, sep&#x3D;&#39; &#39;)</span><br><span class="line">TestA_data &#x3D; pd.read_csv(&#39;text_tree.csv&#39;, sep&#x3D;&#39; &#39;)</span><br><span class="line">numerical_cols &#x3D; Train_data.columns</span><br><span class="line">feature_cols &#x3D; [col for col in numerical_cols if col not in [&#39;price&#39;,&#39;SaleID&#39;]]</span><br><span class="line"></span><br><span class="line">#提前特征列，标签列构造训练样本和测试样本</span><br><span class="line"></span><br><span class="line">X_data &#x3D; Train_data[feature_cols]</span><br><span class="line">X_test &#x3D; TestA_data[feature_cols]</span><br><span class="line">print(X_data.shape)</span><br><span class="line">print(X_test.shape)</span><br><span class="line"></span><br><span class="line">X_data &#x3D; np.array(X_data)</span><br><span class="line">X_test &#x3D; np.array(X_test)</span><br><span class="line">Y_data &#x3D; np.array(Train_data[&#39;price&#39;])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">lightgbm</span><br><span class="line"></span><br><span class="line">&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">#自定义损失函数</span><br><span class="line"></span><br><span class="line">def myFeval(preds, xgbtrain):</span><br><span class="line">    label &#x3D; xgbtrain.get_label()</span><br><span class="line">    score &#x3D; mean_absolute_error(np.expm1(label), np.expm1(preds))</span><br><span class="line">    return &#39;myFeval&#39;, score, False</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">param &#x3D; &#123;&#39;boosting_type&#39;: &#39;gbdt&#39;,</span><br><span class="line">         &#39;num_leaves&#39;: 31,</span><br><span class="line">         &#39;max_depth&#39;: -1,</span><br><span class="line">         &quot;lambda_l2&quot;: 2,  # 防止过拟合</span><br><span class="line">         &#39;min_data_in_leaf&#39;: 20,  # 防止过拟合，好像都不用怎么调</span><br><span class="line">         &#39;objective&#39;: &#39;regression_l1&#39;,</span><br><span class="line">         &#39;learning_rate&#39;: 0.01,</span><br><span class="line">         &quot;min_child_samples&quot;: 20,</span><br><span class="line">         &quot;feature_fraction&quot;: 0.8,</span><br><span class="line">         &quot;bagging_freq&quot;: 1,</span><br><span class="line">         &quot;bagging_fraction&quot;: 0.8,</span><br><span class="line">         &quot;bagging_seed&quot;: 11,</span><br><span class="line">         &quot;metric&quot;: &#39;mae&#39;,</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">folds &#x3D; KFold(n_splits&#x3D;10, shuffle&#x3D;True, random_state&#x3D;2018)</span><br><span class="line">oof_lgb &#x3D; np.zeros(len(X_data))</span><br><span class="line">predictions_lgb &#x3D; np.zeros(len(X_test))</span><br><span class="line">predictions_train_lgb &#x3D; np.zeros(len(X_data))</span><br><span class="line">for fold_, (trn_idx, val_idx) in enumerate(folds.split(X_data, Y_data)):</span><br><span class="line">    print(&quot;fold n°&#123;&#125;&quot;.format(fold_ + 1))</span><br><span class="line">    trn_data &#x3D; lgb.Dataset(X_data[trn_idx], Y_data[trn_idx])</span><br><span class="line">    val_data &#x3D; lgb.Dataset(X_data[val_idx], Y_data[val_idx])</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    num_round &#x3D; 100000000</span><br><span class="line">    clf &#x3D; lgb.train(param, trn_data, num_round, valid_sets&#x3D;[trn_data, val_data], verbose_eval&#x3D;300,</span><br><span class="line">                    early_stopping_rounds&#x3D;600, feval &#x3D; myFeval)</span><br><span class="line">    oof_lgb[val_idx] &#x3D; clf.predict(X_data[val_idx], num_iteration&#x3D;clf.best_iteration)</span><br><span class="line">    predictions_lgb +&#x3D; clf.predict(X_test, num_iteration&#x3D;clf.best_iteration) &#x2F; folds.n_splits</span><br><span class="line">    predictions_train_lgb +&#x3D; clf.predict(X_data, num_iteration&#x3D;clf.best_iteration) &#x2F; folds.n_splits</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(&quot;lightgbm score: &#123;:&lt;8.8f&#125;&quot;.format(mean_absolute_error(np.expm1(oof_lgb), np.expm1(Y_data))))</span><br></pre></td></tr></table></figure>
<p>测试集输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">predictions &#x3D; np.exp(predictions_lgb)-1</span><br><span class="line">predictions[predictions &lt; 0] &#x3D; 0</span><br><span class="line">sub &#x3D; pd.DataFrame()</span><br><span class="line">sub[&#39;SaleID&#39;] &#x3D; TestA_data.SaleID</span><br><span class="line">sub[&#39;price&#39;] &#x3D; predictions</span><br><span class="line"></span><br><span class="line">sub.to_csv(&#39;lgb_test.csv&#39;, index&#x3D;False)</span><br></pre></td></tr></table></figure>
<p>结果：<br><img src="/2020/04/25/%E5%A4%A9%E6%B1%A0-%E4%BA%8C%E6%89%8B%E8%BD%A6%E4%BA%A4%E6%98%93%E4%BB%B7%E6%A0%BC%E9%A2%84%E6%B5%8B/%E6%8E%92%E5%90%8D.PNG" alt></p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 QKX<br></p>
                <p class="copyright text-muted">Original Theme <a target="_blank" href="http://startbootstrap.com/template-overviews/clean-blog/">Clean Blog</a> from <a href="http://startbootstrap.com/" target="_blank">Start Bootstrap</a></p>
                <p class="copyright text-muted">Adapted for <a target="_blank" href="https://hexo.io/">Hexo</a> by <a href="http://www.codeblocq.com/" target="_blank">Jonathan Klughertz</a></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>